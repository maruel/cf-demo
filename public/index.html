<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/svg+xml" href="/favicon.svg">
	<title>Edge Chat</title>
	<style>
		*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

		body {
			font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
			background: #f5f5f5;
			background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='280' height='320' viewBox='0 0 280 320'%3E%3Cg opacity='0.04' fill='none' stroke='%23000' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'%3E%3C!-- head outline --%3E%3Cellipse cx='140' cy='120' rx='62' ry='78'/%3E%3C!-- hair --%3E%3Cpath d='M82 105c2-40 22-65 58-68s54 26 58 65' /%3E%3Cpath d='M86 100c4-32 20-54 50-58s46 18 52 52' /%3E%3C!-- left glasses frame --%3E%3Crect x='92' y='108' width='40' height='30' rx='4'/%3E%3C!-- right glasses frame --%3E%3Crect x='148' y='108' width='40' height='30' rx='4'/%3E%3C!-- bridge --%3E%3Cpath d='M132 120c3-4 13-4 16 0'/%3E%3C!-- left temple --%3E%3Cpath d='M92 116 76 110'/%3E%3C!-- right temple --%3E%3Cpath d='M188 116 204 110'/%3E%3C!-- eyes behind glasses --%3E%3Ccircle cx='112' cy='124' r='4'/%3E%3Ccircle cx='168' cy='124' r='4'/%3E%3C!-- nose --%3E%3Cpath d='M140 134c-1 10-2 16 0 22 3 2 6 2 8 0'/%3E%3C!-- mouth --%3E%3Cpath d='M126 168c6 6 22 6 28 0'/%3E%3C!-- stubble dots --%3E%3Ccircle cx='120' cy='174' r='0.8'/%3E%3Ccircle cx='128' cy='178' r='0.8'/%3E%3Ccircle cx='136' cy='180' r='0.8'/%3E%3Ccircle cx='144' cy='180' r='0.8'/%3E%3Ccircle cx='152' cy='178' r='0.8'/%3E%3Ccircle cx='160' cy='174' r='0.8'/%3E%3Ccircle cx='124' cy='164' r='0.8'/%3E%3Ccircle cx='156' cy='164' r='0.8'/%3E%3Ccircle cx='116' cy='168' r='0.8'/%3E%3Ccircle cx='164' cy='168' r='0.8'/%3E%3C!-- ears --%3E%3Cpath d='M78 118c-6 0-10 6-8 14s6 10 10 8'/%3E%3Cpath d='M202 118c6 0 10 6 8 14s-6 10-10 8'/%3E%3C!-- earbuds wire --%3E%3Cpath d='M80 140c-8 14-10 40-6 60' stroke-dasharray='3 2'/%3E%3Cpath d='M200 140c8 14 10 40 6 60' stroke-dasharray='3 2'/%3E%3C!-- t-shirt collar --%3E%3Cpath d='M104 194c8 8 24 14 36 14s28-6 36-14'/%3E%3Cpath d='M100 198c-20 10-40 30-50 60l0 62 180 0 0-62c-10-30-30-50-50-60'/%3E%3C!-- shirt v-neck --%3E%3Cpath d='M122 202c6 16 12 24 18 28 6-4 12-12 18-28'/%3E%3C%2Fg%3E%3C%2Fsvg%3E");
			background-repeat: repeat;
			color: #1a1a1a;
			height: 100dvh;
			display: flex;
			flex-direction: column;
		}

		header {
			padding: 16px 24px;
			background: #fff;
			border-bottom: 1px solid #e0e0e0;
			font-size: 18px;
			font-weight: 600;
			letter-spacing: -0.02em;
		}

		header span { color: #888; font-weight: 400; font-size: 14px; margin-left: 8px; }

		#messages {
			flex: 1;
			overflow-y: auto;
			padding: 16px 24px;
			display: flex;
			flex-direction: column;
			gap: 8px;
		}

		.msg {
			background: #fff;
			border-radius: 8px;
			padding: 10px 14px;
			box-shadow: 0 1px 3px rgba(0,0,0,0.06);
			max-width: 600px;
			animation: fadeIn 0.2s ease-out;
		}

		.msg .meta {
			font-size: 13px;
			color: #888;
			margin-bottom: 2px;
		}

		.msg .meta strong {
			color: #1a1a1a;
			font-weight: 600;
		}

		.msg .body {
			font-size: 15px;
			line-height: 1.4;
			white-space: pre-wrap;
			word-break: break-word;
		}

		@keyframes fadeIn {
			from { opacity: 0; transform: translateY(4px); }
			to   { opacity: 1; transform: translateY(0); }
		}

		#compose {
			padding: 12px 24px;
			background: #fff;
			border-top: 1px solid #e0e0e0;
			display: flex;
			gap: 8px;
			align-items: center;
		}

		#compose input {
			font-size: 15px;
			padding: 8px 12px;
			border: 1px solid #ddd;
			border-radius: 6px;
			outline: none;
			transition: border-color 0.15s;
		}

		#compose input:focus { border-color: #888; }

		#author { width: 120px; flex-shrink: 0; }
		#body   { flex: 1; }

		#compose button {
			padding: 8px 18px;
			background: #1a1a1a;
			color: #fff;
			border: none;
			border-radius: 6px;
			font-size: 15px;
			cursor: pointer;
			transition: background 0.15s;
			flex-shrink: 0;
		}

		#compose button:hover { background: #333; }
		#compose button:disabled { background: #999; cursor: default; }

		#empty {
			flex: 1;
			display: flex;
			align-items: center;
			justify-content: center;
			color: #aaa;
			font-size: 15px;
		}
	</style>
</head>
<body>
	<header>Edge Chat<span>powered by Durable Objects</span></header>
	<div id="messages"><div id="empty">No messages yet. Say something!</div></div>
	<form id="compose" autocomplete="off">
		<input id="author" type="text" placeholder="Name" maxlength="64" required>
		<input id="body" type="text" placeholder="Message…" maxlength="1000" required>
		<button type="submit">Send</button>
	</form>

	<script>
		const messagesEl = document.getElementById("messages");
		const emptyEl = document.getElementById("empty");
		const authorEl = document.getElementById("author");
		const bodyEl = document.getElementById("body");
		const form = document.getElementById("compose");

		let knownIds = new Set();

		// Restore saved name.
		authorEl.value = localStorage.getItem("chat_author") || "";
		authorEl.addEventListener("input", () => {
			localStorage.setItem("chat_author", authorEl.value);
		});

		function relativeTime(iso) {
			const seconds = Math.floor((Date.now() - new Date(iso + "Z").getTime()) / 1000);
			if (seconds < 5)  return "just now";
			if (seconds < 60) return seconds + "s ago";
			const minutes = Math.floor(seconds / 60);
			if (minutes < 60) return minutes + "m ago";
			const hours = Math.floor(minutes / 60);
			if (hours < 24)   return hours + "h ago";
			return Math.floor(hours / 24) + "d ago";
		}

		function renderMessages(messages) {
			if (!messages.length) return;
			emptyEl?.remove();

			let shouldScroll = messagesEl.scrollTop + messagesEl.clientHeight >= messagesEl.scrollHeight - 40;

			for (const msg of messages) {
				if (knownIds.has(msg.id)) continue;
				knownIds.add(msg.id);

				const div = document.createElement("div");
				div.className = "msg";
				div.innerHTML =
					`<div class="meta"><strong>${esc(msg.author)}</strong> · ${relativeTime(msg.created_at)}</div>` +
					`<div class="body">${esc(msg.body)}</div>`;
				messagesEl.appendChild(div);
			}

			if (shouldScroll) {
				messagesEl.scrollTop = messagesEl.scrollHeight;
			}
		}

		function esc(s) {
			const d = document.createElement("div");
			d.textContent = s;
			return d.innerHTML;
		}

		form.addEventListener("submit", async (e) => {
			e.preventDefault();
			const author = authorEl.value.trim();
			const body = bodyEl.value.trim();
			if (!author || !body) return;

			const btn = form.querySelector("button");
			btn.disabled = true;
			try {
				const resp = await fetch("/api/messages", {
					method: "POST",
					headers: { "Content-Type": "application/json" },
					body: JSON.stringify({ author, body }),
				});
				if (resp.ok) {
					renderMessages(await resp.json());
					bodyEl.value = "";
				}
			} finally {
				btn.disabled = false;
				bodyEl.focus();
			}
		});

		// WebSocket connection with reconnect and version detection.
		let currentVersion = null;
		let reconnectDelay = 1000;
		const MAX_RECONNECT_DELAY = 30000;

		function connect() {
			const proto = location.protocol === "https:" ? "wss:" : "ws:";
			const ws = new WebSocket(`${proto}//${location.host}/api/ws`);

			ws.addEventListener("open", () => {
				reconnectDelay = 1000;
			});

			ws.addEventListener("message", (e) => {
				const msg = JSON.parse(e.data);
				if (msg.type === "version") {
					if (currentVersion === null) {
						currentVersion = msg.version;
					} else if (msg.version !== currentVersion) {
						location.reload();
					}
				} else if (msg.type === "messages") {
					renderMessages(msg.data);
				}
			});

			ws.addEventListener("close", () => scheduleReconnect());
			ws.addEventListener("error", () => ws.close());
		}

		function scheduleReconnect() {
			setTimeout(connect, reconnectDelay);
			reconnectDelay = Math.min(reconnectDelay * 2, MAX_RECONNECT_DELAY);
		}

		connect();

		// Focus message input if name is already set.
		if (authorEl.value) bodyEl.focus();
		else authorEl.focus();
	</script>
</body>
</html>
